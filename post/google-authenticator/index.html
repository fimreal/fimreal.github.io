<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™† - é—²éš…</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Fimreal"><meta name=description content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta name=keywords content="Two Factors Authentication,sshd,secure"><meta name=generator content="Hugo 0.103.1 with theme even"><link rel=canonical href=https://www.epurs.com/post/google-authenticator/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.520181dd342d9369197dd9e27d41b8f7108626419bf37348947efbbba4d9724c.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta property="og:description" content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta property="og:type" content="article"><meta property="og:url" content="https://www.epurs.com/post/google-authenticator/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-06-06T02:40:00+00:00"><meta property="article:modified_time" content="2019-08-19T14:35:05+08:00"><meta itemprop=name content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta itemprop=description content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta itemprop=datePublished content="2019-06-06T02:40:00+00:00"><meta itemprop=dateModified content="2019-08-19T14:35:05+08:00"><meta itemprop=wordCount content="2445"><meta itemprop=keywords content="sshd,secure,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><meta name=twitter:description content="ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>é—²éš…</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>ä¸»é¡µ</li></a><a href=/post/><li class=mobile-menu-item>å½’æ¡£</li></a><a href=/tags/><li class=mobile-menu-item>æ ‡ç­¾</li></a><a href=/categories/><li class=mobile-menu-item>åˆ†ç±»</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>é—²éš…</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>ä¸»é¡µ</a></li><li class=menu-item><a class=menu-item-link href=/post/>å½’æ¡£</a></li><li class=menu-item><a class=menu-item-link href=/tags/>æ ‡ç­¾</a></li><li class=menu-item><a class=menu-item-link href=/categories/>åˆ†ç±»</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ä½¿ç”¨ google_authenticator ç”ŸæˆåŠ¨æ€å¯†ç åŠ å›º ssh ç™»é™†</h1><div class=post-meta><span class=post-time>2019-06-06</span><div class=post-category><a href=/categories/linux/>Linux</a></div><span class=more-meta>çº¦ 2445 å­—</span>
<span class=more-meta>é¢„è®¡é˜…è¯» 5 åˆ†é’Ÿ</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>æ–‡ç« ç›®å½•</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#å‰è¨€>å‰è¨€</a></li><li><a href=#å‡†å¤‡ç¯å¢ƒ>å‡†å¤‡ç¯å¢ƒ</a></li><li><a href=#å®‰è£…-google-authenticator>å®‰è£… google-authenticator</a></li><li><a href=#åˆå§‹åŒ–é…ç½®>åˆå§‹åŒ–é…ç½®</a></li><li><a href=#æ‰‹æœºç«¯é…ç½®>æ‰‹æœºç«¯é…ç½®</a></li><li><a href=#éªŒè¯æµ‹è¯•>éªŒè¯æµ‹è¯•</a></li><li><a href=#æ‰©å±•é…ç½®>æ‰©å±•é…ç½®</a></li></ul></li></ul></nav></div></div><div class=post-content><p>åˆ©ç”¨ google åŠ¨æ€å£ä»¤ç”Ÿæˆå¯†ç ç»™ sshd åšä¸¤æ­¥éªŒè¯å®ç°å®‰å…¨åŠ å¯†ã€‚
åˆæˆ–è€…ç”©æ‰å›ºå®šçš„å¯†ç ï¼Œæ¥ä½¿ç”¨æ‰‹æœº app ç”Ÿæˆçš„åŠ¨æ€å¯†ç ç™»é™†æœåŠ¡å™¨ã€‚
è¿™åªæ˜¯ä¸€äº› <code>pam</code> é…ç½®å®ç°çš„å°æŠ€å·§ã€‚</p><h3 id=å‰è¨€>å‰è¨€</h3><p>æ—©èµ·çœ‹åˆ°ç¾¤é‡Œå‘å…¬ä¼—å·æ¨è¿ç»´å°çŸ¥è¯†ï¼Œ ä»‹ç»ç”¨ Google Authenticatorï¼ˆè°·æ­Œèº«ä»½éªŒè¯å™¨ï¼‰è¿™ä¸ªå·¥å…·æ¥åŠ å›º sshd éªŒè¯ã€‚è¿™ä¸ªåŠ å›ºåŠæ³•å…¶å®å‡ºç°çš„æ—¶é—´æ¯”è¾ƒæ—©äº†ï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³ä¸­é—´äººæ”»å‡»é—®é¢˜ï¼Œè°·æ­Œèº«ä»½éªŒè¯å™¨æ˜¯ä¸€ä¸ªå¯ä»¥åŸºäºæ—¶é—´æ¥ç”Ÿæˆå¯†ç ç”¨äºéªŒè¯çš„æ‰‹æœºç«¯/ç½‘é¡µç«¯ appï¼Œå¯ä»¥é¿å…åŒä¸€å¯†ç è¢«å¤šæ¬¡ä½¿ç”¨ã€‚</p><p>è¿™ä¹ˆæœ‰è¶£çš„åŠŸèƒ½å½“ç„¶è¦å¥½å¥½æŠŠç©ä¸€ä¸‹ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œæ–‡ä¸­å‡ºç°æ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¿è¯<strong>å¹‚ç­‰</strong>æ€§ï¼Œå»ºè®®è¯»æ‡‚æ„æ€åé€šè¿‡ç¼–è¾‘å™¨ä¿®æ”¹ã€‚</p><h3 id=å‡†å¤‡ç¯å¢ƒ>å‡†å¤‡ç¯å¢ƒ</h3><p>è¿™é‡Œä½¿ç”¨ CoreOS æœåŠ¡å™¨ï¼Œæ¥æµ‹è¯•å®‰è£…ä½“éªŒã€‚</p><p>æµ‹è¯•è®¡åˆ’ä¸»è¦ç”¨åˆ°ä¸¤ç§ Liunx ç¯å¢ƒï¼Œ<code>Ubuntu(debian)</code> å’Œ <code>Fedore(rhel/centos)</code> ï¼Œè¿™é‡Œ <code>Fedore</code> å¯ä»¥è§†ä½œ <code>CentOS</code> ï¼Œå…¨æ–‡é™¤äº†å®‰è£…ï¼Œé…ç½®ä¸Šå„å¤§å‹ç‰ˆå‡ ä¹æ²¡æœ‰åŒºåˆ«ã€‚å…¶ä¸­ <code>Ubuntu</code> ä½¿ç”¨ Docker é•œåƒåˆ›å»ºï¼Œ <code>Fedore</code> ä½¿ç”¨ CoreOS è‡ªå¸¦çš„ <code>toolbox</code> ç¯å¢ƒï¼Œç”¨æ¥æµ‹è¯•ã€‚</p><h3 id=å®‰è£…-google-authenticator>å®‰è£… google-authenticator</h3><p>è¿™é‡Œå®‰è£…åªåšæœ€ç®€é…ç½®ï¼Œå¦‚æœ <code>Fedore</code> æƒ³è¦ä½¿ç”¨äºŒç»´ç æ‰‹æœºæ‰«æï¼Œåˆ™éœ€è¦å®‰è£… <code>qrencode</code>ï¼Œé»˜è®¤ <code>ubuntu</code> ä¼šè‡ªå·±è£…ä¸Šã€‚</p><p><strong>Fedore</strong></p><p>ä½¿ç”¨ dnf å®‰è£… google-authenticator å³å¯ã€‚
dnf æ˜¯ yum å‡çº§ç‰ˆï¼Œå‘åå…¼å®¹ yum å­å‘½ä»¤ï¼ŒFedore ä¸­ yum è¢«è½¯é“¾æ¥æŒ‡å‘ dnf-3ï¼Œåœ¨ CentOS7 ä¸­é…ç½®ç›¸åŒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dnf install google-authenticator openssh-server -y
</span></span></code></pre></td></tr></table></div></div><p><strong>Ubuntu</strong></p><p>é»˜è®¤å®¹å™¨å¯åŠ¨ ubuntu-18.04 ç‰ˆæœ¬ï¼Œdebian ç³»å®‰è£…åŒ…éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p><p>æ¢ç”¨æ”¯æŒ <code>http</code> çš„ä¸­ç§‘å¤§æºï¼Œå®‰è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i.bak <span class=s1>&#39;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#39;</span> /etc/apt/sources.list
</span></span><span class=line><span class=cl>apt update <span class=o>&amp;&amp;</span> apt install libpam-google-authenticator openssh-server -y
</span></span></code></pre></td></tr></table></div></div><p><strong>Alpine</strong></p><p>Alpine Linux çš„ apk æºä¸­ä¹Ÿæœ‰åŒ…ï¼Œç•¥éº»çƒ¦ä¸€ç‚¹ï¼Œå®‰è£…åŠæ³•å¯ä»¥å‚è€ƒ <a href=https://wiki.alpinelinux.org/wiki/Two_Factors_Authentication_With_OpenSSH>wiki</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apk add google-authenticator openssh-server-pam
</span></span></code></pre></td></tr></table></div></div><p><strong>Arch/Manjaro</strong></p><p>åº”è¯¥ä¸ç”¨å¤šè¯´ï¼Œå¯ä»¥å‚è€ƒ [wiki](<a href=https://wiki.archlinux.org/index.php/Google_Authenticator_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)>https://wiki.archlinux.org/index.php/Google_Authenticator_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)</a></p><h3 id=åˆå§‹åŒ–é…ç½®>åˆå§‹åŒ–é…ç½®</h3><p>åœ¨ <code>Ubuntu</code> å®¹å™¨å†…æ‰§è¡Œåˆå§‹åŒ–ï¼Œä¸ <code>Fedore</code> åˆå§‹åŒ–é…ç½®è¿‡ç¨‹ä¸€æ ·ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@2a52e5dc9569:/# google-authenticator
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Do you want authentication tokens to be time-based <span class=o>(</span>y/n<span class=o>)</span> y
</span></span><span class=line><span class=cl> &lt;è¿™é‡Œæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„äºŒç»´ç åŠé“¾æ¥ï¼Œå¯ä»¥æ‰«ç ç»‘å®šæ‰‹æœº app &gt;
</span></span><span class=line><span class=cl>Your new secret key is: 2MX4BZPDXZONH6SVUPMUC3SO5M    <span class=o>(</span>ç”¨äºç»‘å®šæ‰‹æœº app çš„å¯†é’¥<span class=o>)</span>
</span></span><span class=line><span class=cl>Your verification code is <span class=m>768806</span>                      <span class=o>(</span>éªŒè¯ç <span class=o>)</span>
</span></span><span class=line><span class=cl>Your emergency scratch codes are:                     <span class=o>(</span>å¤‡ç”¨ä»¤ç‰Œç ï¼Œç”¨ä¸€ä¸ªå°‘ä¸€ä¸ª<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>43344880</span>
</span></span><span class=line><span class=cl>  <span class=m>98680948</span>
</span></span><span class=line><span class=cl>  <span class=m>43923070</span>
</span></span><span class=line><span class=cl>  <span class=m>26622686</span>
</span></span><span class=line><span class=cl>  <span class=m>60782611</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Do you want me to update your <span class=s2>&#34;/root/.google_authenticator&#34;</span> file? <span class=o>(</span>y/n<span class=o>)</span> y
</span></span><span class=line><span class=cl><span class=o>(</span>æ˜¯å¦è¦†ç›– <span class=s2>&#34;/root/.google_authenticator&#34;</span> æ–‡ä»¶ï¼Œå¦‚æœä¹‹å‰ç”Ÿæˆè¿‡æ–‡ä»¶éœ€è¦è°¨æ…ç¡®è®¤<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Do you want to disallow multiple uses of the same authentication
</span></span><span class=line><span class=cl>token? This restricts you to one login about every 30s, but it increases
</span></span><span class=line><span class=cl>your chances to notice or even prevent man-in-the-middle attacks <span class=o>(</span>y/n<span class=o>)</span> y
</span></span><span class=line><span class=cl><span class=o>(</span>æ˜¯å¦æ‹’ç»å¤šæ¬¡ä½¿ç”¨ä½¿ç”¨ç›¸åŒçš„ä»¤ç‰Œï¼Ÿè¿™å°†é™åˆ¶ä½ æ¯30sä»…èƒ½ç™»å½•ä¸€æ¬¡ï¼Œä½†ä¼šæé†’/é˜»æ­¢ä¸­é—´äººæ”»å‡»ã€‚<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>By default, a new token is generated every <span class=m>30</span> seconds by the mobile app.
</span></span><span class=line><span class=cl>In order to compensate <span class=k>for</span> possible time-skew between the client and the server,
</span></span><span class=line><span class=cl>we allow an extra token before and after the current time. This allows <span class=k>for</span> a
</span></span><span class=line><span class=cl><span class=nb>time</span> skew of up to <span class=m>30</span> seconds between authentication server and client. If you
</span></span><span class=line><span class=cl>experience problems with poor <span class=nb>time</span> synchronization, you can increase the window
</span></span><span class=line><span class=cl>from its default size of <span class=m>3</span> permitted codes <span class=o>(</span>one previous code, the current
</span></span><span class=line><span class=cl>code, the next code<span class=o>)</span> to <span class=m>17</span> permitted codes <span class=o>(</span>the <span class=m>8</span> previous codes, the current
</span></span><span class=line><span class=cl>code, and the <span class=m>8</span> next codes<span class=o>)</span>. This will permit <span class=k>for</span> a <span class=nb>time</span> skew of up to <span class=m>4</span> minutes
</span></span><span class=line><span class=cl>between client and server.
</span></span><span class=line><span class=cl>Do you want to <span class=k>do</span> so? <span class=o>(</span>y/n<span class=o>)</span> n
</span></span><span class=line><span class=cl><span class=o>(</span>æ˜¯å¦å°†çª—å£æ—¶é—´ç”±1åˆ†30ç§’å¢åŠ åˆ°çº¦4åˆ†é’Ÿï¼Ÿè¿™å°†ç¼“è§£æ—¶é—´åŒæ­¥é—®é¢˜ã€‚<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>If the computer that you are logging into isn<span class=err>&#39;</span>t hardened against brute-force
</span></span><span class=line><span class=cl>login attempts, you can <span class=nb>enable</span> rate-limiting <span class=k>for</span> the authentication module.
</span></span><span class=line><span class=cl>By default, this limits attackers to no more than <span class=m>3</span> login attempts every 30s.
</span></span><span class=line><span class=cl>Do you want to <span class=nb>enable</span> rate-limiting? <span class=o>(</span>y/n<span class=o>)</span> y
</span></span><span class=line><span class=cl><span class=o>(</span>æ˜¯å¦å¯ç”¨æ­¤æ¨¡å—çš„ç™»å½•é¢‘ç‡é™åˆ¶ï¼Œç™»å½•è€…å°†ä¼šè¢«é™åˆ¶ä¸ºæœ€å¤šåœ¨30ç§’å†…ç™»å½•3æ¬¡ã€‚<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢è¿™æ­¥ä¼šåœ¨ <code>/root/.google_authenticator</code> ç”ŸæˆéªŒè¯æ–‡ä»¶ã€‚</p><p>ç„¶åå†æ‰“å¼€ <code>sshd</code> é…ç½®ä¸­ <code>pam</code> æ¨¡å—ï¼Œå¹¶å¯ç”¨äº¤äº’å¼ç™»é™†ï¼Œå…¶å®å°±æ˜¯æ‰“å¼€ <code>ChallengeResponseAuthentication</code> å’Œ <code>UsePAM</code> é€‰é¡¹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i.bak <span class=s1>&#39;1i UsePAM yes\nChallengeResponseAuthentication yes&#39;</span> /etc/ssh/sshd_config
</span></span></code></pre></td></tr></table></div></div><p>æ·»åŠ æ–°çš„ pam æ”¯æŒï¼Œé™¤äº† <code>Alpine Linux</code> é»˜è®¤éƒ½ä¼šæœ‰ <code>/etc/pam.d/sshd</code> é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œç›´æ¥æŠŠ google_authenticator æ”¾åœ¨ç¬¬ä¸€è¡ŒåŠ è½½å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i.bak <span class=s1>&#39;1i auth            sufficient      pam_google_authenticator.so&#39;</span> /etc/pam.d/sshd
</span></span></code></pre></td></tr></table></div></div><p>è¡¥å……è¯´æ˜ï¼š<code>sufficient</code> é…ç½®ï¼ŒæŒ‡æ˜å¯ä»¥ä½¿ç”¨ <code>google_authenticator</code> è¿›è¡ŒéªŒè¯ç™»é™†ï¼ŒéªŒè¯æˆåŠŸåï¼Œå¦‚æœéœ€è¦é…ç½®ä¸¤æ­¥éªŒè¯ï¼ŒæŠŠ <code>sufficient</code> æ”¹ä¸º <code>required</code> å³å¯ã€‚</p><p>pam æ§åˆ¶å‘½ä»¤ç®€å•è¯´æ˜ï¼š</p><ul><li><strong>required</strong> å¿…é¡»è¦éªŒè¯çš„æ¨¡å—ã€‚åœ¨æ‰€æœ‰æ­¥éª¤éªŒè¯å®Œæ¯•åè¿”å›éªŒè¯ä¿¡æ¯ã€‚</li><li><strong>requisite</strong> å¿…é¡»è¦éªŒè¯çš„æ¨¡å—ã€‚å‡ºé”™ç«‹åˆ»è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li><li><strong>sufficient</strong> éªŒè¯æˆåŠŸå³é€šè¿‡çš„æ¨¡å—ã€‚æˆåŠŸåä¸ä¼šç«‹å³è¿”å›æˆåŠŸä¿¡æ¯ã€‚</li><li><strong>optional</strong> å¤±è´¥æ—¶ä¼šå¿½ç•¥çš„æ¨¡å—ã€‚</li><li><strong>include</strong> éªŒè¯æ—¶åŠ è½½å…¶ä»–é…ç½®æ–‡ä»¶ã€‚</li><li><strong>substack</strong></li></ul><h3 id=æ‰‹æœºç«¯é…ç½®>æ‰‹æœºç«¯é…ç½®</h3><p>è¿™é‡Œä¸è€ƒè™‘å®‰è£… <code>qrencode</code> çš„æƒ…å†µï¼Œå·®åˆ«åªåœ¨äºç»‘å®šæ‰‹æœº app çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æ‰‹åŠ¨è¾“å…¥ï¼Œä¸€ä¸ªæ˜¯æ‰«ç è€Œå·²ã€‚</p><p>æ‰‹æœºç«¯ä¸‹è½½å®‰è£…ï¼š IOS åœ¨ Appstore æœç´¢ &ldquo;Authenticator&rdquo;ï¼›Android æœç´¢ &ldquo;è°·æ­ŒåŠ¨æ€å£ä»¤&rdquo; ã€‚</p><p>å®‰è£…æ‰“å¼€åï¼Œç‚¹å‡»å³ä¸Šè§’ â€œ+â€ ï¼Œé€‰æ‹© æ‰«æäºŒç»´ç æˆ–è€…è¾“å…¥éªŒè¯ç </p><p><img src=https://od.epurs.com/images/2019/06/06/OrQR5XLo5p/google_authentication_0.png alt></p><p>åœ¨ç³»ç»Ÿä¸­å¯ä»¥æŸ¥çœ‹ <code>/root/.google_authenticator</code> æ–‡ä»¶æ‰¾åˆ°é…ç½®çš„éªŒè¯ç </p><p>æ‰‹æœºç«¯è¾“å…¥åä¿å­˜</p><p><img src=https://od.epurs.com/images/2019/06/06/yKcQVHE4DR/google_authentication_1.png alt></p><h3 id=éªŒè¯æµ‹è¯•>éªŒè¯æµ‹è¯•</h3><p>ä¸Šè¿°é…ç½®å®Œæˆåï¼Œæ‰‹åŠ¨æ‰“å¼€ <code>sshd</code> æœåŠ¡ï¼ŒéªŒè¯éªŒè¯è¿æ¥è¿‡ç¨‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚</p><p>ç”±äºå®¹å™¨ç¯å¢ƒæ–°å®‰è£…çš„ <code>sshd</code> æœåŠ¡è¿˜æ²¡æœ‰è‡ªåŠ¨åˆå§‹åŒ–é…ç½®ï¼Œéœ€è¦é¢å¤–æ‰§è¡Œä¸€äº›æ­¥éª¤ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;PermitRootLogin yes&#39;</span> &gt;&gt; /etc/ssh/sshd_config  <span class=c1>## å…è®¸ root ç”¨æˆ·ç™»é™†</span>
</span></span><span class=line><span class=cl>ssh-keygen -A       <span class=c1># ç”ŸæˆæœåŠ¡å™¨ key</span>
</span></span><span class=line><span class=cl>mkdir /run/sshd     <span class=c1># åˆ›å»ºè¿è¡Œç¯å¢ƒç›®å½•</span>
</span></span><span class=line><span class=cl>hostname -I         <span class=c1># æ‹¿åˆ°å®¹å™¨ IP</span>
</span></span><span class=line><span class=cl>/usr/sbin/sshd -d   <span class=c1># å‰å°è¿è¡Œ sshd æœåŠ¡</span>
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•è¿æ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -v 172.17.0.1
</span></span><span class=line><span class=cl>... ...              <span class=o>(</span>å…¬é’¥éªŒè¯<span class=o>)</span>
</span></span><span class=line><span class=cl>ECDSA key fingerprint is SHA256:/9Z8rQasLV5qsSVfwMc+vsvanpNpoWYd2B2c31Uc6lk.
</span></span><span class=line><span class=cl>Are you sure you want to <span class=k>continue</span> connecting <span class=o>(</span>yes/no<span class=o>)</span>? yes
</span></span><span class=line><span class=cl>Warning: Permanently added <span class=s1>&#39;172.17.0.6&#39;</span> <span class=o>(</span>ECDSA<span class=o>)</span> to the list of known hosts.
</span></span><span class=line><span class=cl>debug1: rekey after <span class=m>134217728</span> blocks
</span></span><span class=line><span class=cl>debug1: SSH2_MSG_NEWKEYS sent
</span></span><span class=line><span class=cl>debug1: expecting SSH2_MSG_NEWKEYS
</span></span><span class=line><span class=cl>debug1: SSH2_MSG_NEWKEYS received
</span></span><span class=line><span class=cl>debug1: rekey after <span class=m>134217728</span> blocks
</span></span><span class=line><span class=cl>debug1: SSH2_MSG_EXT_INFO received
</span></span><span class=line><span class=cl>debug1: kex_input_ext_info: server-sig-algs<span class=o>=</span>&lt;ssh-ed25519,ssh-rsa,rsa-sha2-256,rsa-sha2-512,ssh-dss,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521&gt;
</span></span><span class=line><span class=cl>debug1: SSH2_MSG_SERVICE_ACCEPT received
</span></span><span class=line><span class=cl>debug1: Authentications that can <span class=k>continue</span>: publickey,password,keyboard-interactive
</span></span><span class=line><span class=cl>debug1: Next authentication method: publickey
</span></span><span class=line><span class=cl>debug1: Trying private key: /root/.ssh/id_rsa
</span></span><span class=line><span class=cl>debug1: Trying private key: /root/.ssh/id_dsa
</span></span><span class=line><span class=cl>debug1: Trying private key: /root/.ssh/id_ecdsa
</span></span><span class=line><span class=cl>debug1: Trying private key: /root/.ssh/id_ed25519
</span></span><span class=line><span class=cl>debug1: Trying private key: /root/.ssh/id_xmss
</span></span><span class=line><span class=cl>debug1: Next authentication method: keyboard-interactive
</span></span><span class=line><span class=cl>Verification code: &lt;è¾“å…¥æ‰‹æœºä¸ŠåŠ¨æ€å¯†ç &gt;
</span></span><span class=line><span class=cl>Password: &lt;ç³»ç»Ÿå†…å¯¹åº”ç”¨æˆ·å¯†ç &gt;
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœé…ç½®å’Œå‰é¢ä¸€æ ·ï¼Œè¿™é‡Œè¾“å…¥æ‰‹æœºæ˜¾ç¤ºçš„æ­£ç¡®åŠ¨æ€å¯†ç åï¼Œå¯ä»¥ç›´æ¥ç™»é™†æœåŠ¡å™¨ã€‚</p><p>å¦‚æœè¾“å…¥é”™è¯¯ï¼Œä¼šè¿›ä¸€æ­¥éªŒè¯ç™»é™†ç”¨æˆ·å¯¹åº”çš„å¯†ç ï¼Œè¾“å…¥æ­£ç¡®å¯†ç ï¼Œä¹Ÿå¯ç™»é™†ã€‚</p><h3 id=æ‰©å±•é…ç½®>æ‰©å±•é…ç½®</h3><h4 id=1-å°†-ubuntu-ä¸­çš„é…ç½®åº”ç”¨åˆ°-fedore-å…¶ä»–ç³»ç»Ÿä¸­>1. å°† <code>Ubuntu</code> ä¸­çš„é…ç½®åº”ç”¨åˆ° <code>Fedore</code> (å…¶ä»–)ç³»ç»Ÿä¸­</h4><p>ç›®çš„ï¼šä¸åŒå‘è¡Œç‰ˆï¼Œæˆ–è€…è¯´ä¸åŒä¸»æœºé…ç½®è¿ç§»ï¼Œæœ€ç»ˆå…±äº«åŒä¸€ä¸ªé…ç½®ï¼Œä½¿æ‰‹æœºç«¯åŠ¨æ€å¯†ç å¯ä»¥ç™»é™†ä¸åŒä¸»æœºã€‚</p><p>åœ¨å…ˆå‰é…ç½®ä¸­å·²ç»æåˆ°è¿‡ <code>Fedore</code> ç³»ç»Ÿå®‰è£…è¿‡ç¨‹ï¼Œè¿™æ­¥è¿›è¡Œå®Œæˆåï¼Œå…ˆè·³è¿‡ <code>google-authenticator</code> åˆå§‹åŒ–æ­¥éª¤ã€‚</p><p>ä¿è¯ä¸‹é¢é…ç½®æ­£ç¡®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i.bak <span class=s1>&#39;1i UsePAM yes\nChallengeResponseAuthentication yes&#39;</span> /etc/ssh/sshd_config               <span class=c1># ç¡®ä¿æ‰“å¼€ pam æ”¯æŒ å’Œ äº¤äº’å¼éªŒè¯</span>
</span></span><span class=line><span class=cl>sed -i.bak <span class=s1>&#39;1i auth            sufficient      pam_google_authenticator.so&#39;</span> /etc/pam.d/sshd  <span class=c1># pam ä¸­æ·»åŠ  google_authenticator éªŒè¯æ¨¡å—</span>
</span></span></code></pre></td></tr></table></div></div><p>å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ° <code>~/.google_authenticator</code>ï¼Œæˆ–è€…é€šè¿‡ç¼–è¾‘å™¨ç¼–è¾‘æ·»åŠ è¯¥æ–‡ä»¶ã€‚æ–‡ä»¶è¦ç¡®ä¿å±ä¸»æ­£ç¡®ï¼Œæƒé™ä¸º <code>600</code> æˆ–è€…æ›´ä½ã€‚å¦‚æœæ˜¯ root ç”¨æˆ·ï¼Œéœ€è¦ç¡®è®¤ sshd é…ç½®å¯ä»¥è¿œç¨‹ç™»é™†ã€‚</p><p>é…ç½®å®Œæˆé‡å¯ sshd æœåŠ¡å³å¯ã€‚</p><h4 id=2-ç¦ç”¨è´¦å·å¯†ç ç™»é™†>2. ç¦ç”¨è´¦å·å¯†ç ç™»é™†</h4><p>ç›®çš„ï¼šå½“ä½¿ç”¨å¯†é’¥ç™»é™†æ—¶ï¼Œä¸æƒ³åŒæ—¶å¼€å¯å¯†ç ç™»é™†ã€‚</p><p>æ³¨æ„ï¼š è¯¥é…ç½®éœ€è¦ openssh 6.2 ä»¥ä¸Šæ”¯æŒï¼Œå‚è€ƒ <a href=https://wiki.archlinux.org/index.php/OpenSSH#Two-factor_authentication_and_public_keys>Arch wiki</a> è¯´æ˜ã€‚
è¿™é‡Œä¿®æ”¹ <code>/etc/ssh/sshd_config</code> æ–‡ä»¶ä¸­ï¼Œ<code>PasswordAuthentication yes</code> æ”¹ä¸º <code>PasswordAuthentication no</code> ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºå¯ç”¨ PAM éªŒè¯åï¼Œpam é…ç½®ä¸­é»˜è®¤æœ‰åŸºäºå¯†ç éªŒè¯ã€‚</p><p>åœ¨ä¸Šè¿°é…ç½®åŸºç¡€ä¸Šï¼š</p><p><code>Ubuntu</code> ç³»ç»Ÿæ³¨é‡Šæ‰ <code>/etc/pam.d/sshd</code> ä¸­ <code>@include common-auth</code> å³å¯å…³é—­å¯†ç éªŒè¯ã€‚
<code>Fedore</code> ç³»ç»Ÿæ³¨é‡Šæ‰ <code>/etc/pam.d/sshd</code> ä¸­ <code>auth substack password-auth</code> å³å¯å…³é—­å¯†ç éªŒè¯ã€‚</p><p>åŒç†ï¼Œä¸å¼€å¯å¯†é’¥ç™»é™†ï¼Œè¿™æ—¶å°†åªèƒ½é€šè¿‡åŠ¨æ€å¯†ç ç™»é™†ã€‚åˆ«å¿˜äº†åˆå§‹åŒ–æ—¶è¿˜æœ‰å‡ ä¸ªä¸€æ¬¡æ€§å¤‡ç”¨å¯†ç ã€‚</p><h4 id=3-ä½¿ç”¨æµè§ˆå™¨æ’ä»¶æŸ¥çœ‹åŠ¨æ€å¯†ç >3. ä½¿ç”¨æµè§ˆå™¨æ’ä»¶æŸ¥çœ‹åŠ¨æ€å¯†ç </h4><p>Chrome æ’ä»¶ï¼šhttps://t.cn/E9oafuV</p><p>Firefox æ’ä»¶ï¼šhttps://t.cn/zjaEAlS</p></div><footer class=post-footer><div class=post-tags><a href=/tags/sshd/>sshd</a>
<a href=/tags/secure/>secure</a></div><nav class=post-nav><a class=prev href=/post/a-shell-script-for-searhing-docker-image-tags/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">ä¸€ä¸ªæŸ¥æ‰¾ Docker é•œåƒåŒ…å« tag çš„è„šæœ¬</span>
<span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span></a>
<a class=next href=/post/nginx-proxy-cache-regular-configuration/><span class="next-text nav-default">nginx location è§„åˆ™ä½¿ç”¨æ­£åˆ™æ—¶æ”¹å†™ request_uri æŠ¥é”™</span>
<span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=vcomments></div><script src=//cdn1.lncld.net/static/js/3.0.4/av-min.js></script>
<script src=//unpkg.com/valine/dist/Valine.min.js></script>
<script type=text/javascript>new Valine({el:"#vcomments",appId:"GbB0g7iuHvLyDClFmsBwewUS-gzGzoHsz",appKey:"cq9Rl1lkMWGfkEoq93b6t3bJ",notify:!0,verify:!0,avatar:"mp",placeholder:"Say something...",visitor:!1})</script></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:&amp;#108;&amp;#109;&amp;#114;&amp;#64;&amp;#101;&amp;#112;&amp;#117;&amp;#114;&amp;#115;&amp;#46;&amp;#99;&amp;#111;&amp;#109; class="iconfont icon-email" title=email></a>
<a href=https://www.epurs.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>ç”± <a class=hexo-link href=https://gohugo.io>Hugo</a> å¼ºåŠ›é©±åŠ¨</span>
<span class=division>|</span>
<span class=theme-info>ä¸»é¢˜ -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2018 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>Fimreal</span>
<a class=theme-link href=http://beian.miit.gov.cn>äº¬ICPå¤‡18059304å·-1</a>
<a href=https://webify.cloudbase.net/>ğŸš€ Powered by CloudBase Webify</a></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-138489412-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>